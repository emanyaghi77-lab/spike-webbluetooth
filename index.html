<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>SPIKE Manual B,E,F</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>body{font-family:Arial;padding:12px} button{padding:10px;margin:6px}</style>
</head>
<body>
  <h3>تحكم يدوي — المحركات B, E, F</h3>
  <button id="connect">اتصال بالـHub</button>
  <div id="status">غير متصل</div>

  <div style="margin-top:12px">
    <div><strong>B (portId=1)</strong>
      <button onclick="sendStart(1,80)">تشغيل B 80%</button>
      <button onclick="sendCoast(1)">Coast</button>
      <button onclick="sendBrake(1)">Brake</button>
    </div>
    <div><strong>E (portId=4)</strong>
      <button onclick="sendStart(4,80)">تشغيل E 80%</button>
      <button onclick="sendCoast(4)">Coast</button>
      <button onclick="sendBrake(4)">Brake</button>
    </div>
    <div><strong>F (portId=5)</strong>
      <button onclick="sendStart(5,80)">تشغيل F 80%</button>
      <button onclick="sendCoast(5)">Coast</button>
      <button onclick="sendBrake(5)">Brake</button>
    </div>
  </div>

<script>
  const LWP3_SERVICE = '00001623-1212-efde-1623-785feabcd123';
  const LWP3_CHAR    = '00001624-1212-efde-1623-785feabcd123';
  let char = null;

  async function connectHub(){
    document.getElementById('status').textContent = 'جاري الاتصال...';
    try{
      const device = await navigator.bluetooth.requestDevice({
        acceptAllDevices: true,
        optionalServices: [LWP3_SERVICE]
      });
      const server = await device.gatt.connect();
      const service = await server.getPrimaryService(LWP3_SERVICE);
      char = await service.getCharacteristic(LWP3_CHAR);
      document.getElementById('status').textContent = 'متصل';
    }catch(e){
      document.getElementById('status').textContent = 'فشل الاتصال: ' + (e.message || e);
      console.error(e);
    }
  }

  async function sendStart(portId, speed){
    if (!char) { alert('اتصل أولاً'); return; }
    // StartSpeed message length=9
    const s = ((speed + 256) & 0xFF); // signed int8 -> byte
    const bytes = new Uint8Array([0x09,0x00,0x81,portId & 0xFF,0x11,0x07, s, 100, 0x00]);
    await char.writeValue(bytes);
    console.log('start',portId,bytes);
  }

  async function sendCoast(portId){
    if (!char) { alert('اتصل أولاً'); return; }
    const bytes = new Uint8Array([0x08,0x00,0x81,portId & 0xFF,0x11,0x51,0x00,0x00]);
    await char.writeValue(bytes);
    console.log('coast',portId);
  }

  async function sendBrake(portId){
    if (!char) { alert('اتصل أولاً'); return; }
    const bytes = new Uint8Array([0x08,0x00,0x81,portId & 0xFF,0x11,0x51,0x00,0x7F]);
    await char.writeValue(bytes);
    console.log('brake',portId);
  }

  document.getElementById('connect').addEventListener('click', connectHub);
</script>
</body>
</html>
